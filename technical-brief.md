<!-- File: technical-brief.md -->

# بریف فنی کامل پروژه
## پلتفرم آموزش داستان‌نویسی با رویکرد ترکیبی – نسخهٔ MVP + فاز ۱ خلاقیت

**تاریخ:** جمعه، ۲۸ نوامبر ۲۰۲۵  
**نسخه:** ۱.۱.۰  
**معماری مرجع:** `architecture-fortified-monolith.md`  

این سند، تصویر فنی نهایی و بدون ابهام از سیستم در نسخهٔ MVP (به همراه فاز ۱ خلاقیت) ارائه می‌دهد و رابط بین:

- سند دامنهٔ **۳۳ فصلی** (`product-domain-spec.md`)  
- و سند معماری فنی (`architecture-fortified-monolith.md`)

است.  

> **نکته:** در صورت افزودن فصل‌های جدید به سند دامنه و تغییر تعداد ۳۳ فصل، این ارجاع باید به‌روزرسانی شود.

هر تصمیم طراحی و پیاده‌سازی باید با این بریف و `architecture-fortified-monolith.md` منطبق باشد. هر تغییر جدی در دامنه یا معماری باید در قالب ADR مستقل ثبت شود.

---

## ۱. هویت محصول، مخاطب و دامنهٔ MVP

### ۱.۱. ماهیت محصول (هم‌سو با فصل‌های ۱ و ۲ دامنه)

- پلتفرمی برای آموزش داستان‌نویسی که:
  - هم **کتاب چاپی ۱۶ فصلی** دارد،
  - هم **پلتفرم آنلاین تمرین و بازخورد**.
- اصل بنیادین: **پلتفرم‌اول**:
  - ابتدا پلتفرم ساخته و در عمل آزموده می‌شود،
  - سپس کتاب بر اساس داده‌های واقعی و نمونه‌های اثبات‌شده چاپ می‌شود.
- در فاز پیش از چاپ کتاب:
  - تجربه به‌صورت کامل آنلاین است،
  - UI از مفاهیم «فصل ۱…۱۵» استفاده نمی‌کند، اگرچه ساختار فصل‌ها در لایهٔ دامنه تعریف شده است ([فصل سوم دامنه](./product-domain-spec.md#chapter-3)).
- در فاز پس از چاپ:
  - حالت کتاب (Book Mode) فعال می‌شود،
  - کدهای پاسخ‌گو و صفحات فصل‌ها در UI نمایان می‌شوند و کتاب چاپی به پلتفرم متصل می‌شود.

### ۱.۲. مخاطب و نقش‌ها (هم‌سو با فصل چهاردهم و شانزدهم دامنه)

- مخاطب اولیه: نویسندگان فارسی‌زبان (اغلب در ایران) که:
  - در مراحل آغازین/میانی مسیر یادگیری هستند،
  - به تمرین عملی و بازخورد نیاز دارند، نه فقط تئوری.

- نقش‌ها (مطابق [فصل شانزدهم دامنه](./product-domain-spec.md#chapter-16)):

  - **User (دانشجو):**
    - دسترسی به محتوای آموزشی و مسیرها،
    - انجام تمرین‌ها،
    - دریافت بازخورد AI و منتور،
    - مشارکت در حلقه‌های نقد همتا (Critique Circles) در بازۀ سنی مجاز،
    - مدیریت تنظیمات حساب و داده.
  - **Mentor (منتور):**
    - نوشتن بازخورد انسانی روی تمرین‌ها،
    - پیشنهاد نمونه‌های برگزیده.
  - **Content Manager (مدیر محتوا):**
    - مدیریت فصل‌ها و نسخه‌های محتوا،
    - مدیریت ContentItemها،
    - انتخاب نهایی نمونه‌های برگزیده،
    - مدیریت آرشیو گفتگوها.
  - **Ops Manager (مدیر عملیات):**
    - پایش سلامت سیستم، خطاها، بار، SLAها.
  - **Finance (حسابدار مالی):**
    - دیدن تراکنش‌ها و گزارش‌های مالی.
  - **Legal/Abuse (ناظر حقوقی و تخلف):**
    - بررسی و پاسخ به گزارش‌های تخلف،
    - پیگیری رخدادهای امنیتی خاص.
  - **Owner/Admin (مدیر مسئول):**
    - سطح دسترسی بالاترین،
    - کنترل کلی پیکربندی سیستم،
    - اقداماتش تحت Audit Log ثبت می‌شود.

### ۱.۳. سیاست سنی و حریم هویتی (فصل چهاردهم دامنه)

- **حداقل سن ثبت‌نام:**  
  - فقط کاربران **۱۳ سال و بالاتر** می‌توانند حساب کاربری بسازند؛  
  - کاربران زیر ۱۳ سال می‌توانند به‌عنوان مهمان، برخی محتوای عمومی سایت را بدون ثبت‌نام و بدون ذخیرۀ دادهٔ شخصی شناسایی‌پذیر مشاهده کنند، اما حساب کاربری نخواهند داشت.

- **گروه‌های سنی:**
  - **Teen (نوجوان):** ۱۳ تا ۱۷ سال؛
  - **Adult (بزرگسال):** ۱۸ سال به بالا.

- **سیاست‌ها:**
  - **۱۸+ (Adult):**
    - مشارکت کامل در تمام بخش‌ها (به‌جز محدودیت‌های معمول قوانین سایت) مجاز است.
  - **۱۳–۱۷ (Teen):**
    - دسترسی به محتوای آموزشی، تمرین‌ها، بازخورد AI و انسانی و خرید اشتراک/اعتبار مجاز است؛ مسئولیت جنبه‌های حقوقی خرید در Terms و شرایط استفاده به عهدهٔ کاربر و/یا ولی قانونی اوست و در MVP مکانیزم فنی جداگانه‌ای برای تأیید والد پیاده نمی‌شود.  
    - **Critique Circles:**  
      - فقط در حلقه‌های مخصوص نوجوانان (`age_band='teen'`) عضو می‌شوند؛  
      - هیچ حلقهٔ مختلط (Teen + Adult) وجود ندارد.
    - **دیسکورد:**
      - ۱۳–۱۵ سال: دسترسی فقط خواندن به کانال‌های عمومی، بدون امکان ارسال پیام؛
      - ۱۶–۱۷ سال: از نظر ارسال پیام محدودیتی بیشتر از مقررات کلی جامعه ندارند.
  - **زیر ۱۳ سال:**
    - امکان ساخت حساب کاربری ندارند؛
    - تنها می‌توانند به‌عنوان مهمان برخی محتوای عمومی را مشاهده کنند.

- **حریم هویتی:**
  - کاربران می‌توانند با نام مستعار ثبت‌نام کنند؛  
  - فیلدهای ثبت‌نام به شکلی طراحی می‌شوند که:
    - ایمیل، نام مستعار، تاریخ تولد، کشور، زبان و جنسیت (با گزینهٔ «مایل به گفتن نیستم») ضروری هستند؛
    - نام واقعی، شماره تلفن و شهر محل سکونت اختیاری‌اند؛
    - در سیاست داده (Data Policy) برای هر فیلد توضیح داده می‌شود چرا جمع‌آوری می‌شود و چگونه استفاده خواهد شد.

- **تغییر بازۀ سنی در طول زمان:**
  - اگر کاربر در طول استفاده به بازۀ بالاتر منتقل شود (مثلاً از ۱۷ به ۱۸)، حلقه‌ها و ساختارهایی که قبلاً در آن‌ها عضو شده تغییر نمی‌کنند؛  
  - از آن به بعد، حلقه‌های جدید، سیاست دیسکورد و سایر محدودیت‌ها بر اساس بازۀ سنی جدید او اعمال خواهد شد.

### ۱.۴. دامنهٔ MVP (خلاصهٔ هماهنگ با فصل‌های ۵ تا ۱۰ دامنه)

MVP شامل موارد زیر است:

1. احراز هویت (Supabase Auth) با Email+Password و دیسکورد.
2. نمایش حداقل یک مسیر آموزشی کامل («از ایده تا طرح کوتاه»).
3. سیستم ارسال تمرین:
   - شروع، ذخیرهٔ پیش‌نویس، ارسال نهایی.
4. بازخورد ترکیبی:
   - AI Feedback سقراطی،
   - Human Feedback از منتورها (در سناریوهای کلیدی).
5. حلقه‌های نقد (Critique Circles) به عنوان فیچر تمایزدهندۀ MVP:
   - حلقه‌های سه‌نفره (ظرفیت پیش‌فرض ۳، قابل تنظیم بین ۲ تا ۱۰ در لایهٔ Config)،
   - Exercise-specific (هر حلقه برای یک تمرین مشخص در یک Path مشخص)،
   - جداسازی بر اساس زبان (`fa/en`) و بازهٔ سنی (`teen/adult`)،
   - نقد متقابل تمرین‌ها،
   - قفل مشارکت (تعداد نقد لازم N به‌صورت پویا: `N = min(2, تعداد تمرین‌های دیگران در همان حلقه)`، حداقل طول ۲۰۰ و حداکثر ۵۰۰۰ کاراکتر برای هر نقد)،
   - محدودیت تعداد حلقه‌های فعال بر حسب نوع کاربر (عادی/دارای اشتراک فعال) با تعریف عملیاتی «حلقۀ فعال برای کاربر».
6. مدیریت محتوای پایه (ContentItemها) و لینک‌های آن‌ها (ContentLinks).
7. سیستم پرداخت داخل ایران (زرین‌پال) برای اشتراک/اعتبار/خرید کتاب دیجیتال (EPUB) و سایر محصولات.
8. سیستم پرداخت خارج از ایران با USDT روی پالیگان، برای:
   - خرید نسخۀ دیجیتال کتاب (EPUB+NFT)،
   - خرید اشتراک‌ها،
   - خرید اعتبار نقد انسانی.  
   معیار داخل/خارج بودن، فیلد `country` در پروفایل کاربر است (مثلاً `IR` برای ایران).
9. سیاست‌های داده و حریم خصوصی:
   - Opt-in Analytics برای کاربران لاگین‌شده،
   - ثبت رویدادهای مهمان به‌صورت غیرشخصی (بدون user_id و با IP ناشناس‌شده)،
   - حذف حساب (با دو حالت «ناشناس‌سازی مشارکت‌ها» و «حذف کامل مشارکت‌ها»)،
   - ثبت رضایت‌ها،
   - گزارش تخلف.
10. فاز ۱ خلاقیت (MVP-Level):
    - Skill Tree (درخت مهارت جمعی) – آمار تجمیعی ساده و غیررقابتی،
    - داشبورد شفافیت و رشد شخصی (نمودار scoreهای AI)،
    - **Idea Playground (زمین بازی ایده‌ها) – مود Creative Clash به عنوان بازی تعاملی خلاقیت**:
      - سه گردونۀ تصادفی (شخصیت، مکان، شیء/مفهوم)،
      - ۶۰ ثانیه فرصت نوشتن یک Logline که هر سه را پوشش دهد،
      - امکان استفادهٔ عمومی (حتی برای مهمان)؛ در نسخۀ MVP، متن Logline الزاماً به‌صورت دائم در پایگاه‌داده ذخیره نمی‌شود و بیشتر نقش تمرین زنده را دارد (هرچند ممکن است شمارۀ دفعات استفاده در سطح آمار تجمیعی ثبت شود).
11. آماده‌سازی Book Mode در معماری (بدون نمایش در UI پیش از چاپ).

مودهای دیگر Idea Playground (مثل مینی‌داستان یا «اتاق فرار کلمات») برای فازهای بعدی رزرو شده و در این بریف تنها به سطح «احتمال توسعه» اشاره می‌شوند، نه بخشی از MVP.

---

## ۲. معماری کلان و پشتهٔ تکنولوژی (خلاصهٔ سند معماری)

### ۲.۱. معماری Fortified Monolith

- Backend:
  - Monolith ماژولار Node.js/TypeScript با Contextهای دامنه‌ای،
  - اتصال به Postgres، Valkey، Meilisearch، S3.
- Frontend:
  - اپ Next.js 16.0.4 (App Router) برای تمام UI (Public + App + Admin),
  - از i18n Next برای `fa/en` استفاده می‌کند.
- Workers:
  - AI Worker (بازخورد سقراطی)،
  - Publishing Worker (واترمارک EPUB و صدور DownloadToken)،
  - Crypto/NFT Worker (برای پرداخت‌های USDT/Polygon و Mint NFT برای کاربران خارج از ایران).
- Edge:
  - Cloudflare (CDN + WAF + Workers) برای:
    - بهبود TTFB/LCP،
    - IP Anonymization (شامل IPv4 و IPv6)،
    - منطق سبک Edge (مثلاً واکنش بدون حساب در فصل ۱۶).

### ۲.۲. پشتهٔ انتخابی

- **Frontend:**  
  - Next.js 16.0.4  
  - React 19.2  
  - TypeScript (strict)  
  - CSS/Design System RTL-ready  

- **Backend:**  
  - Node.js 24 LTS  
  - Fastify/Express (REST API)  
  - TypeScript (strict)  

- **Database:** PostgreSQL 18.1  
- **Cache & Queue:** Valkey 9.0.0 + BullMQ  
- **Search:** Meilisearch 1.27.0  
- **Storage:** S3-compatible (Cloudflare R2/MinIO)  
- **Edge & DNS & WAF:** Cloudflare  
- **Auth:** Supabase Auth (Email+Password, Discord)  
- **AI:** Claude 3.5 Sonnet / GPT‑4o از طریق Worker AI (با تنظیمات no-training/no-retention در صورت پشتیبانی سرویس‌دهنده)  
- **Community:** Discord Bot (Node.js) + سرور دیسکورد  
- **Observability:** Prometheus + Grafana + Loki + Sentry  

(جزئیات بیشتر در `architecture-fortified-monolith.md` آمده است.)

---

## ۳. مدل دادهٔ کلان (Domain Model – خلاصه)

این بخش، نسخهٔ اجرایی مدل مفهومی [فصل بیست‌وششم دامنه](./product-domain-spec.md#chapter-26) است.

### ۳.۱. کاربران و نقش‌ها

- `users` (فیلدهای کلیدی):
  - `id (uuidv7)`,
  - `auth_user_id (uuid)` – پیوند یک‌به‌یک با کاربر Supabase Auth، یونیک و non-null؛
  - `email` (یونیک, Not Null),
  - `display_name` (نام مستعار؛ ۳–۱۵ کاراکتر، Validation در سطح اپ),
  - `date_of_birth` (DATE؛ برای محاسبۀ سن و تعیین Teen/Adult),
  - `country` (کد کشور، مثل `IR`),
  - `preferred_language` (`'fa' | 'en'`),
  - `gender` (`'female' | 'male' | 'non_binary' | 'prefer_not_to_say'`),
  - `city` (اختیاری),
  - `phone` (اختیاری),
  - `created_at`, `updated_at`.

- `roles`, `user_roles`:
  - نقش‌ها: `user`, `mentor`, `content_manager`, `ops_manager`, `finance`, `legal`, `admin`.

### ۳.۲. فصل‌ها و محتوا

- `chapters` و `chapter_versions`:
  - `chapter_versions`: `chapter_id`, `language`, `book_version`, `title`, `body`, `status`, `is_current`, `created_at`.
- `content_items` و `content_links`:
  - مطابق معماری: ContentItem + ContentContext.

### ۳.۳. مسیر آموزشی و تمرین‌ها

- `learning_paths`:
  - `id`, `title`, `description`, `language`, …
- `sessions`:
  - `id`, `path_id`, `title`, `order`, …
- `exercises`:
  - `id`, `path_id`, `session_id`, `title`, `description`, `language`, `is_critique_enabled`, …
- `submissions`:
  - `id (uuidv7)`, `user_id`, `exercise_id`, `language`,  
  - `draft_content`, `final_content`,  
  - `status` (`draft`, `submitted`, `ai_reviewed`, `human_reviewed`, …),  
  - `submitted_at`,  
  - `circle_id?` (denormalized FK به `CritiqueCircle` با `ON DELETE SET NULL`),  
  - `peer_feedback_unlocked (bool)`,  
  - `created_at`, `updated_at`.

### ۳.۴. بازخورد AI و انسانی

- `ai_feedback`:
  - `id`, `submission_id`, `model_name`, `payload (JSONB)`, `created_at`.

  نمونهٔ `payload`:

  ```json
  {
    "overall_impression": "...",
    "strengths": ["..."],
    "areas_for_exploration": ["..."],
    "questions_to_consider": ["..."],
    "suggested_experiments": ["..."],
    "score": {
      "narrative_clarity": 3,
      "character_depth": 4,
      "language_use": 3
    }
  }
  ```

  - `score` در لایهٔ داده یک Map عمومی `metric_name → number` است؛ سه کلید فوق در MVP استفاده می‌شوند.

- `human_feedback`:
  - `id`, `submission_id`, `mentor_id`, `body`, `created_at`.

### ۳.۵. Critique Circles (حلقه‌های نقد)

- `critique_circles`:
  - `id`, `name?`,  
  - `status ('open'|'active'|'closed')`,  
  - `capacity` (پیش‌فرض ۳، بین ۲ و ۱۰)،  
  - `language` (`'fa'|'en'`),  
  - `path_id` (شناسهٔ مسیر آموزشی),  
  - `exercise_id` (شناسهٔ تمرین),  
  - `age_band` (`'teen'|'adult'`),  
  - `owner_id?`,  
  - `created_at`, `updated_at`.

- `circle_members`:
  - `id`, `circle_id`, `user_id`, `role ('member'|'owner')`, `joined_at`, `left_at?`, `UNIQUE(circle_id, user_id)`.

- `circle_submissions`:
  - `id`, `circle_id`, `submission_id`, `author_id`, `created_at`, `UNIQUE(circle_id, submission_id)`.

- `peer_feedback`:
  - `id`, `circle_id`, `submission_id`, `reviewer_id`, `body`, `score?`, `created_at`, `UNIQUE(circle_id, submission_id, reviewer_id)`.

**نکات:**

- حلقه‌ها به‌طور صریح **Exercise-specific** هستند (یک تمرین در یک مسیر و زبان و بازۀ سنی):  
  - همۀ `circle_submissions` در یک حلقه باید متعلق به همان `exercise_id` و همان `path_id` و همان `language` و همان `age_band` باشند.
- `age_band` به‌صورت محاسبه‌ای از `users.date_of_birth` در زمان Join استخراج می‌شود:
  - ۱۳–۱۷ → `'teen'`,
  - ۱۸+ → `'adult'`.

### ۳.۶. نمونه‌های برگزیده، پرداخت، Compliance، Analytics

- Featured:
  - `featured_candidates`, `featured_samples`, `consents`.
- پرداخت:
  - `transactions`, `subscriptions`, `user_credits`,
  - `crypto_payments`, `wallet_token_links`,
  - `download_tokens`.
- Compliance:
  - `reports`, `deletion_requests`, `security_events`.
- Analytics:
  - `events_behavior`, `events_technical`.
- Reactions (دادهٔ عملیاتی لایک‌ها):
  - جدولی مانند `reactions(device_fingerprint, content_id, reaction_type, created_at, updated_at)` که device-based است و به user_id متصل نیست؛  
    رویداد تحلیلی لایک به‌عنوان `reaction_like` در `events_behavior` و فقط در صورت Opt-in ثبت می‌شود.

---

## ۴. فرایندهای کلیدی

### ۴.۱. ثبت‌نام، ورود و نقش‌ها

- کاربر می‌تواند با:
  - **ایمیل + رمز** ثبت‌نام کند،
  - یا با **دیسکورد** وارد شود.

- در فرم ثبت‌نام با ایمیل، فیلدهای زیر الزاماً جمع‌آوری می‌شوند:
  - `email` (یونیک، اجباری)،
  - `display_name` (نام مستعار ۳–۱۵ کاراکتر، طبق قواعد محتوایی)،
  - `password`,
  - `date_of_birth` (برای سن و بازۀ سنی Teen/Adult)،
  - `country` (برای تفکیک داخل/خارج ایران و سیاست پرداخت/NFT)،
  - `preferred_language` (`fa` یا `en`)،
  - `gender` (یکی از: `female`, `male`, `non_binary`, `prefer_not_to_say`).

- فیلدهای اختیاری:
  - نام و نام خانوادگی،
  - شهر،
  - شماره تلفن.

**قواعد نام مستعار (در Validation Backend شکست می‌خورد اگر نقض شود):**

- طول ۳ تا ۱۵ کاراکتر؛
- کاراکترهای مجاز:
  - حروف فارسی (با فاصلهٔ معمول)،
  - حروف لاتین،
  - اعداد؛
- عدم وجود:
  - توهین قومیتی/نژادی/مذهبی،
  - الفاظ جنسی آشکار،
  - جعل هویت رسمی (مثلاً «پشتیبانی سایت») مگر برای اکانت‌های رسمی.

- **Supabase Auth:**
  - مسؤول صدور JWT/Session است.
- Backend:
  - پس از Auth، از روی `auth_user_id`، رکورد `users` را ایجاد/به‌روزرسانی می‌کند،
  - نقش‌های پایه (`user`) را اختصاص می‌دهد،
  - در صورت نیاز، نقش‌های دیسکورد را با `user_roles` همگام می‌کند.
  - سن کاربر را از `date_of_birth` محاسبه کرده و در صورت `< 13` ثبت‌نام را رد می‌کند.

**فلو ورود با Discord:**

- کاربر با کلید «ورود با دیسکورد» به OAuth دیسکورد هدایت می‌شود.
- پس از بازگشت موفق، Backend با Supabase Auth یک user Auth ایجاد/به‌روز می‌کند (با `auth_user_id` جدید یا موجود).
- اگر پروفایل داخلی `users` برای این `auth_user_id` وجود نداشته باشد یا ناقص باشد:
  - کاربر به صفحهٔ «تکمیل پروفایل» در Frontend هدایت می‌شود تا فیلدهای ضروری دامنه (ایمیل قابل‌تماس، نام مستعار، تاریخ تولد، کشور، زبان ترجیحی، جنسیت) را تکمیل کند؛
  - تا زمانی که این فرم تکمیل نشده، حساب از نظر دامنه‌ای فعال تلقی نمی‌شود (اجازهٔ ورود به مسیرها، پرداخت و Critique Circles داده نمی‌شود).

---

### ۴.۲. آغاز و ارسال تمرین

تشریح کامل مطابق [فصل پنجم دامنه](./product-domain-spec.md#chapter-5):

1. کاربر در `/[lang]/dashboard` مسیر «از ایده تا طرح کوتاه» را می‌بیند.
2. برای هر تمرین:
   - `start` → `POST /paths/{pathId}/exercises/{exerciseId}/start`:
     - ایجاد Submission با `status='draft'` و `language` براساس تمرین/کاربر.
   - Autosave → `PATCH /submissions/{id}`:
     - به‌روزرسانی `draft_content`.
   - `submit` → `POST /submissions/{id}/submit`:
     - Validate (مالکیت، طول متن، محدودیت تعداد ارسال در روز – پیش‌فرض حداکثر ۱۰ ارسال نهایی در ۲۴ ساعت که در Config قابل تنظیم است)،
     - `status='submitted'`, `submitted_at=now()`,
     - push Job به Queue `feedback:ai` (برای تمرین‌هایی که AI Feedback دارند).

**نکتهٔ مهم دربارۀ سهمیۀ ۱۰ تمرین/روز:**

- این محدودیت روی **تعداد ارسال نهایی (Submit)** اعمال می‌شود؛ یعنی هر بار که Submission از `draft` به `submitted` می‌رود، یک واحد از سهمیۀ روزانه مصرف می‌شود.
- حذف بعدی Submission، سهمیۀ مصرف‌شده را آزاد نمی‌کند؛ این تصمیم برای جلوگیری از سوءاستفادۀ احتمالی (submit/delete مکرر) اتخاذ شده است.

3. اگر `is_critique_enabled` برای تمرین `true` باشد:
   - در صفحهٔ تأیید، پیشنهاد پیوستن به حلقهٔ نقد (Critique Circle) داده می‌شود.

---

### ۴.3. بازخورد AI (سقراطی) و Human

#### ۴.۳.۱. AI Feedback (هم‌سو با فصل ششم دامنه و معماری)

- Worker AI:
  - از Queue `feedback:ai` مصرف می‌کند.
  - Submission را می‌خواند (متن + زبان).
  - Prompt سقراطی می‌سازد.
  - LLM را صدا می‌زند،
  - پاسخ را validate می‌کند (ساختار JSON و وجود کلیدهای مورد انتظار),
  - در `ai_feedback.payload` ذخیره می‌کند،
  - `submissions.status` را به `ai_reviewed` تغییر می‌دهد.

- API:
  - `GET /submissions/{id}/feedback`:
    - AI + Human Feedback را به‌طور ترکیبی برمی‌گرداند.

#### ۴.۳.۲. Human Feedback

- منتورها:
  - از پنل `/admin/mentors` لیست Submissionهای نیازمند نقد را می‌بینند (صف مشترک).
  - یک Submission را Claim می‌کنند.
  - با `POST /mentor/submissions/{id}/feedback` نقد خود را ثبت می‌کنند.
- Human Feedback:
  - توضیح‌محور و غیردستور‌دهنده است.
  - اگر:
    - AI چند بار خروجی نامعتبر برگرداند،
    - یا کاربر روی بازخورد AI پرچم بزند که «این بازخورد منصفانه یا مفید نبود»،
    - یا محتوا حساس تشخیص داده شود،  
    Submission می‌تواند به‌طور خودکار در صف منتورها نیز قرار گیرد.

---

### ۴.۴. Critique Circles (حلقه‌های نقد)

این بخش، خلاصۀ پیاده‌سازی فرایندهایی است که در `feature-spec-critique-circles.md` با جزئیات کامل آمده‌اند.

#### ۴.۴.۱. Join به حلقه

- Endpoint: `POST /api/circles/join`
- ورودی:
  ```json
  {
    "submissionId": "uuid"
  }
  ```
- منطق:

1. اعتبارسنجی این‌که Submission:
   - متعلق به user فعلی است،
   - `status >= submitted` دارد،
   - تمرین مربوطه `is_critique_enabled=true` است.

2. استخراج Context:
   - `exerciseId` از Submission/Exercise،
   - `pathId` از Exercise،
   - `language` از Submission/Exercise،
   - `age_band` از محاسبۀ سن کاربر:
     - ۱۳–۱۷ → `'teen'`,
     - ۱۸+ → `'adult'`.

3. بررسی محدودیت حلقه بر حسب نوع کاربر، با تعریف «حلقۀ فعال برای کاربر»:

   - **حلقۀ فعال برای کاربر** یعنی:
     - کاربر در `circle_members` عضو حلقه است (`left_at IS NULL`)،
     - و برای Submission خودش در آن حلقه هنوز `peer_feedback_unlocked = false` است (هنوز تعداد نقد لازم را ننوشته).

   - **کاربر عادی:**
     - اگر کاربر عادی در هر حلقه‌ای با شرایط بالا عضو باشد → خطا (`CIRCLE_LIMIT_REACHED`).

   - **کاربر دارای اشتراک فعال:**
     - تشخیص با وجود `Subscription` فعال (`status='active'` و `expires_at > NOW()`).
     - اگر در همان Path حلقۀ فعال دارد → خطا (`CIRCLE_LIMIT_REACHED_FOR_PATH`).
     - اگر در دو حلقۀ فعال (در دو Path مختلف) عضو باشد و برای سومی درخواست بدهد:
       - Join مجاز است،
       - Backend در پاسخ `warning: true, warningCode: 'MULTIPLE_ACTIVE_CIRCLES'` برمی‌گرداند.

4. اگر `submissions.circle_id` مقدار دارد:
   - حلقه واکشی و در پاسخ برگردانده می‌شود (رفتار idempotent).

5. اگر `submissions.circle_id` تهی باشد:
   - تلاش برای یافتن حلقۀ `open` با:
     - `language = lang`,
     - `path_id = pathId`,
     - `exercise_id = exerciseId`,
     - `age_band = userAgeBand`,
     - `status = 'open'`,
     - `membersCount < capacity`.
   - اگر حلقه یافت شد:
     - افزودن user به `circle_members` (در صورت نبود).
     - افزودن Submission به `circle_submissions`.
     - تنظیم `submissions.circle_id`.
     - اگر ظرفیت پر شد → `status='active'`.
   - اگر یافت نشد:
     - ایجاد حلقۀ تازه با:
       - `status='open'`,
       - `capacity=DEFAULT_CAPACITY (3)`,
       - `language=lang`,
       - `path_id=pathId`,
       - `exercise_id=exerciseId`,
       - `age_band=userAgeBand`,
       - `owner_id=currentUserId`.
     - سپس همان مراحل قبلی.

---

#### ۴.۴.۲. مشاهدهٔ حلقه

- Endpoint: `GET /api/circles/my`
- وظیفه:
  - نمایش حلقه‌ای که user در آن عضو است و از دید او «در حال حاضر مربوط» است:
    - ابتدا حلقه‌ای با `status IN ('open','active')` که user در آن عضو است،
    - در صورت تعدد، اولویت با حلقه‌ای که هنوز برای user `peer_feedback_unlocked=false` دارد.
  - نمایش اعضا، لیست تمرین‌های دیگران، وضعیت نقدهای داده‌شده،
  - نمایش وضعیت `feedbackUnlocked` برای تمرین خود کاربر.

---

#### ۴.۴.۳. ثبت نقد همتا

- Endpoint: `POST /api/peer-feedback`
- ورودی:
  ```json
  {
    "circleId": "uuid",
    "submissionId": "uuid",
    "body": "متن نقد من...",
    "score": 4
  }
  ```
- قواعد:
  - user باید عضو circle باشد،
  - Submission باید به همان circle تعلق داشته باشد،
  - `authorId` مربوط به آن Submission نباید `currentUserId` باشد (self-review ممنوع)،
  - فقط یک نقد per (circle, submission, reviewer) مجاز است،
  - طول متن `body` باید بین ۲۰۰ و ۵۰۰۰ کاراکتر باشد.

- منطق:
  - ذخیرهٔ نقد،
  - شمارش نقدهای معتبر نوشته‌شده توسط user روی Submissionهای دیگران (`authorId != currentUserId`) در همان حلقه،
  - محاسبۀ N مؤثر برای آن کاربر در آن حلقه:  
    `N_effective = min(2, تعداد Submissionهای دیگران در حلقه برای این کاربر)`،
  - اگر `count >= N_effective` → `peer_feedback_unlocked=true` برای Submissionهای user در آن حلقه و باز کردن دسترسی او به نقدهای دریافتی.

**پاسخ موفق (۲۰۱ Created):**

```json
{
  "success": true,
  "unlockedOwnFeedback": true
}
```

- اگر هنوز به حد نصاب نرسیده باشد: `unlockedOwnFeedback = false`.

**خطاها:**

- `400 Bad Request`:
  - ورودی ناقص،
  - متن نقد کمتر از ۲۰۰ یا بیشتر از ۵۰۰۰ کاراکتر (`FEEDBACK_TOO_SHORT` یا `FEEDBACK_TOO_LONG`).
- `403 Forbidden`:
  - user عضو حلقه نیست (`NOT_MEMBER`)،
  - self-review (`SELF_REVIEW_NOT_ALLOWED`).
- `404 Not Found`:
  - حلقه یا Submission در آن حلقه وجود ندارد.
- `409 Conflict`:
  - نقد تکراری (`DUPLICATE_FEEDBACK`).

---

#### ۴.۴.۴. گزارش تخلف

- Endpoint: `POST /api/circles/report`
- منطق:
  - گرفتن `circleId`, `submissionId`, `peerFeedbackId` + `reason`, `details`,
  - ثبت در جدول `reports` با `context='critique_circle_peer_feedback'`,
  - استفاده توسط ماژول Compliance برای بررسی (هم‌سو با [فصل پانزدهم دامنه](./product-domain-spec.md#chapter-15)).

---

#### ۴.۴.۵. تست سناریوهای محدودیت حلقه‌ها

در فاز تست (رجوع به `build-plan-stage5.md`، فاز ۵)، این سناریوها باید پوشش داده شوند:

| سناریو | کاربر | عمل | نتیجهٔ مورد انتظار |
|:-------|:------|:----|:-------------------|
| ۱ | عادی | join به حلقهٔ اول | موفق |
| ۲ | عادی | join به حلقهٔ دوم (در حالی که حلقۀ اول هنوز `peer_feedback_unlocked=false` دارد) | خطای CIRCLE_LIMIT_REACHED |
| ۳ | دارای اشتراک فعال | join در Path A | موفق |
| ۴ | دارای اشتراک فعال | join در Path B | موفق |
| ۵ | دارای اشتراک فعال | join دوم در همان Path A | خطا (CIRCLE_LIMIT_REACHED_FOR_PATH) |
| ۶ | دارای اشتراک فعال | join در Path C (سومین حلقه، در حالی که دو حلقۀ قبلی برای او فعال‌اند) | موفق + `warning=true` |
| ۷ | دارای اشتراک فعال با ۳ حلقه | مشاهدهٔ `/circles` | نمایش هشدار UI «شما در ۳ حلقۀ هم‌زمان فعال هستید» |

(در فاز تست می‌توان سناریوهای اضافی برای حلقه‌های دو‌نفره و رفتار N پویا نیز اضافه کرد.)

---

### ۴.۵. ContentItemها و مرکز یادگیری

- ContentManager از `/admin/content` ContentItemها و Links را مدیریت می‌کند.
- کاربر از `/[lang]/resources` و صفحات تمرین/فصل‌ها محتوای عمومی و تکمیلی را می‌بیند.

---

### ۴.۶. پرداخت و مدل کسب‌وکار

- **داخل ایران (زرین‌پال):**
  - Flow:
    - Intent → Redirect → Callback → Verify → ثبت Transaction →:
      - فعال‌سازی `subscriptions` (اشتراک‌ها)،
      - افزایش `user_credits` (اعتبار نقد انسانی)،
      - ایجاد رکورد خرید نسخۀ دیجیتال (EPUB واترمارک‌شده) + صدور DownloadToken.

- **خارج از ایران (USDT روی پالیگان، توسط Crypto Worker):**
  - در MVP، کلیۀ محصولات در دسترس کاربران خارج از ایران (نسخۀ دیجیتال کتاب، اشتراک‌ها، اعتبار نقد انسانی) از این کانال عبور می‌کنند.
  - برای تشخیص داخل/خارج، از فیلد `country` در پروفایل کاربر استفاده می‌شود (`IR` = داخل؛ سایر = خارج).
  - برای نسخۀ دیجیتال کتاب:
    - تأیید تراکنش →  
      - Publishing Worker: واترمارک EPUB، ذخیره در S3، صدور DownloadToken؛  
      - Crypto Worker: Mint NFT، ثبت در `wallet_token_links`.
  - در موارد استثنایی و بروز خطا، کاربر می‌تواند txHash را از طریق ایمیل یا دیسکورد به پشتیبانی ارسال کند، اما فلو رسمی و اصلی همان Intent+API+Worker است.

- **رفتار بازپرداخت دیجیتال (هم‌سو با فصل ۱۳ دامنه):**
  - تا قبل از تحویل واقعی (اولین دانلود موفق EPUB برای کاربران داخل، یا ایجاد NFT/تحویل EPUB برای کاربران خارج) → امکان لغو/بازپرداخت در موارد مشکل.
  - پس از تحویل → بازپرداخت وجود ندارد، چون محصول قابل کپی است.

---

### ۴.۷. حذف حساب و شفافیت داده

- Endpoint: `POST /me/delete-account`.
- UI دو گزینه را به کاربر نمایش می‌دهد:
  1. ناشناس‌سازی مشارکت‌ها؛
  2. حذف کامل مشارکت‌ها.
- Backend:
  - `AccountDeletionService` را فراخوانی می‌کند؛
  - رفتار دقیق طبق [فصل هفدهم دامنه](./product-domain-spec.md#chapter-17) و بخش ۴.۷ سند معماری است:
    - در حالت ناشناس‌سازی:
      - رکورد user حذف می‌شود؛
      - برای جداول جامعه‌محور (Critique Circles، Peer Feedback و…) FKهای `user_id`/`author_id`/`reviewer_id` به `NULL` ست می‌شوند؛
      - متن تمرین‌ها و نقدهای همتا بدون پیوند به هویت باقی می‌مانند.
    - در حالت حذف کامل:
      - علاوه بر حذف user، تمرین‌ها و نقدهای مرتبط او نیز حذف می‌شوند؛
      - نقدهای دیگران روی تمرین‌های او نیز ممکن است به‌واسطۀ `ON DELETE CASCADE` روی `submission_id` حذف شوند.

- **نحوۀ انجام حذف در MVP:**
  - در نسخهٔ MVP، حذف حساب به‌صورت **هم‌زمان (synchronous)** انجام می‌شود:
    - کاربر روی «حذف حساب» کلیک می‌کند،
    - UI در چند ثانیه وضعیت «در حال پردازش…» نشان می‌دهد،
    - پس از تکمیل عملیات، کاربر از همهٔ نشست‌ها خارج شده و پیام موفقیت دریافت می‌کند.
  - عملیات‌های بسیار سنگین احتمالی آینده می‌توانند در پس‌زمینه ادامه یابند، اما از دید کاربر حذف حساب بلافاصله اعمال‌شده تلقی می‌شود.

- **کتاب دیجیتال و حذف حساب:**
  - با حذف حساب، توانایی کاربر برای دریافت DownloadToken جدید و دسترسی آنلاین مجدد به EPUB قطع می‌شود؛
  - فقط نسخه‌هایی که پیش‌تر روی دستگاه او ذخیره شده‌اند باقی می‌مانند؛
  - این نکته در UI مراحل حذف حساب به‌صورت شفاف ذکر می‌شود.

- `/[lang]/me/transparency`:
  - خلاصهٔ داده‌های ذخیره‌شده و وضعیت درخواست‌های حذف، همراه با نمودار رشد فردی (trend scoreهای AI) را نمایش می‌دهد.

---

## ۵. حریم خصوصی و داده (اجرای فصل ۱۷ و ۱۸ دامنه)

### ۵.۱. کمینه‌سازی داده

- فقط داده‌هایی جمع‌آوری می‌شوند که:
  - برای Auth،
  - سیاست سنی/کشوری،
  - یادگیری،
  - پرداخت،
  - و Analytics اختیاری
  ضروری هستند.
- فیلدهای ضروری/اختیاری مطابق [فصل چهاردهم دامنه](./product-domain-spec.md#chapter-14) هستند.

### ۵.۲. IP Anonymization و Logging

- **ناشناس‌سازی IP:**
  - در Cloudflare Worker، IP کامل از `CF-Connecting-IP` خوانده شده و بلافاصله قبل از انتقال به Backend به صورت زیر ماسک می‌شود:
    - برای IPv4: سه octet نخست نگه داشته می‌شود و octet چهارم صفر می‌شود (`x.y.z.0`);
    - برای IPv6: تنها پیشوند /64 نگه داشته می‌شود و ۶۴ بیت پایانی صفر می‌شود.
  - Worker این مقدار را در هدر `X-Anonymized-IP` قرار می‌دهد و Backend و سیستم‌های Logging فقط همین مقدار را ذخیره می‌کنند.

- **Logging:**
  - در لاگ‌های اپلیکیشن، متریک‌ها (Prometheus) و Sentry، تنها IP ناشناس‌شده (از `X-Anonymized-IP`) ثبت می‌شود؛
  - IP خام Cloudflare (`CF-Connecting-IP`) در سیستم‌های ما لاگ نمی‌شود؛ برای نیازهای امنیتی سطح شبکه، از امکانات خود Cloudflare (WAF و لاگ‌های آن) استفاده می‌شود.

- **security_events:**
  - جدول `security_events` رخدادهای امنیتی را با اشاره به `user_id` (در صورت وجود) ثبت می‌کند؛
  - این داده‌ها تا ۹۰ روز نگه‌داری می‌شوند، حتی اگر حساب کاربر حذف شده باشد، تا امکان بررسی رویدادهای امنیتی وجود داشته باشد؛ این موضوع در سیاست داده به‌وضوح بیان می‌شود.

### ۵.۳. Analytics Opt-in و مهمان‌ها

- **کاربران لاگین‌شده:**
  - جمع‌آوری رویدادهای رفتار کاربر به صورت پیش‌فرض خاموش است و فقط با رضایت صریح کاربر فعال می‌شود (Opt-in);
  - کاربر می‌تواند در `/me/settings` این تنظیم را فعال یا غیرفعال کند.
  - رویدادهای اختیاری شامل:
    - بازدید صفحات،
    - شروع/ذخیره/ارسال تمرین،
    - خوانده‌شدن بازخورد،
    - جست‌وجوی داخلی،
    - اسکن کدهای پاسخ‌گو (به‌صورت تجمیعی)،
    - وب‌ویتال‌ها،
    - ثبت لایک‌ها/واکنش‌ها به عنوان **رویداد تحلیلی**؛  
      دادهٔ عملیاتی لازم برای کارکرد لایک جداگانه (در جدول `reactions` و بدون اتصال به user_id) ذخیره می‌شود.

- **کاربران مهمان (Guest):**
  - ممکن است برخی رویدادها برای تحلیل عمومی (مثلاً میزان استفاده از Idea Playground) ثبت شود؛
  - برای مهمان‌ها:
    - هیچ `user_id`ای ثبت نمی‌شود،
    - تنها یک شناسهٔ نشست موقت (session id) و IP ناشناس‌شده (طبق بند ۵.۲) استفاده می‌شود،
    - رویدادها مانند دیگران حداکثر ۳۰ روز نگه‌داری می‌شوند؛
    - در سیاست داده تصریح می‌شود که این داده‌ها شخصی‌سازی‌شده نیستند و صرفاً برای آمار تجمیعی به‌کار می‌روند.

- **Retention:**
  - `events_behavior` (رویدادهای رفتاری خام): ۳۰ روز؛
  - `events_technical` و `security_events`: ۹۰ روز؛
  - سوابق مالی: ۷ سال.  
  آمارهای تجمیعی کاملاً غیرشخصی (Aggregate) می‌توانند به‌طور بلندمدت نگه داشته شوند، مادامی که قابل‌برگرداندن به فرد نباشند.

- **استفاده از سرویس‌های AI بیرونی:**
  - ارائه‌دهندگان LLM مانند OpenAI/Anthropic در این معماری Data Processor محسوب می‌شوند؛
  - در صورت امکان، درخواست‌ها با تنظیمات «عدم استفاده از داده برای Training عمومی» ارسال می‌شوند؛
  - استفادهٔ داخلی از محتوای کاربران برای بهبود الگوریتم‌ها و آموزش مدل‌های اختصاصی، مطابق سند دامنه، فقط به‌صورت داخلی، ناشناس‌سازی‌شده و تجمیعی انجام می‌شود.

### ۵.۴. داده‌های جامعه‌محور (Critique Circles و نقدهای همتا)

- پیش‌فرض: ناشناس‌سازی مشارکت‌ها پس از حذف حساب، مگر درخواست حذف کامل؛
- در حالت ناشناس‌سازی:
  - FKهای `user_id`/`author_id`/`reviewer_id` به `NULL` تبدیل می‌شوند؛
  - متن تمرین‌ها و نقدهای همتا باقی می‌ماند و در رابط کاربر با برچسب‌هایی مانند «یک کاربر» نمایش داده می‌شود؛
- در حالت حذف کامل:
  - تمرین‌ها و نقدهای مرتبط همراه با آن‌ها حذف می‌شوند، و ممکن است نقدهای دیگران روی تمرین‌های آن کاربر نیز به‌دلیل وابستگی حذف شوند.

### ۵.۵. گزارش شفافیت

- هر سه ماه، گزارش شفافیت شامل:
  - تعداد حذف حساب و نسبت ناشناس‌سازی/حذف کامل،
  - رخدادهای امنیتی،
  - آمار خطاها،
  - تأخیر منتورها،
  - تغییرات سیاست‌ها،
  - و در صورت نیاز، آمار تجمیعی غیرشخصی  
  منتشر می‌شود (مطابق [فصل هجدهم دامنه](./product-domain-spec.md#chapter-18)).

---

## ۶. عملکرد و امنیت

### ۶.۱. اهداف عملکردی (هم‌سو با فصل نوزدهم دامنه)

- **TTFB:**  
  < ۸۰۰ ms برای ۹۵٪ درخواست‌ها (Edge + Next + Cache + CDN).

- **LCP:**  
  ≤ ۳ s روی موبایل میان‌رده در 4G ایران.

- **Availability:**  
  ~۹۹.۹٪ (حدود ۴۰ دقیقه قطعی مجاز در ماه).

- **Error Rate:**  
  - عملیات خواندن: < ۰.۳٪،  
  - نوشتن: < ۰.۵٪.

### ۶.۲. Rate Limit

- بر مسیرهای زیر:
  - Login/Register،
  - Submit تمرین (`POST /submissions/.../submit`)،
  - بازخوردها (`/mentor/submissions/.../feedback`, `/submissions/{id}/feedback`)،
  - Reports (`/reports`, `/api/circles/report`)،
  - واکنش‌های بدون حساب (لایک فصل شانزدهم)،
  - **Critique APIs:** `POST /api/circles/join`, `POST /api/peer-feedback`.

### ۶.۳. SLAهای اختصاصی Critique Circles (پیشنهادی/هدف‌گذاری)

- **زمان پاسخ APIهای Critique Circles (در شرایط عادی):**
  - `POST /api/circles/join`: < ۵۰۰ ms (P95)
  - `GET /api/circles/my`: < ۳۰۰ ms (P95)
  - `POST /api/peer-feedback`: < ۵۰۰ ms (P95)

- این اعداد در داشبوردهای Prometheus/Grafana مانیتور می‌شوند.

### ۶.۴. امنیت

- TLS، WAF، مدیریت Secrets،
- Audit Log برای نقش‌های حساس،
- ثبت رخدادهای امنیتی در `security_events`,
- اجرای RBAC سخت‌گیرانه در Backend،
- استفاده از IPهای ماسک‌شده در Logging داخلی.

---

## ۷. فاز ۱ خلاقیت و پس از MVP

این بخش بر اساس فصل‌های ۱۹، ۳۰ و ۳۳ دامنه و تصمیمات معماری تنظیم شده است.

### ۷.۱. Skill Tree (درخت مهارت جمعی) و داشبورد فردی

- **Skill Tree عمومی (آمار جمعی):**
  - نمایش در صفحهٔ اصلی / داشبورد عمومی:
    - تعداد تمرین‌های کامل‌شدهٔ کل سیستم،
    - تعداد مسیرهای تمام‌شدهٔ کل سیستم،
    - تعداد کاربران فعال.
  - بدون leaderboard یا نمایش scoreهای فردی/میانگین در MVP.

- **داشبورد رشد فردی:**
  - فقط برای خود کاربر:
    - نمودار trend امتیازهای AI (سه معیار اصلی)،
    - تعداد تمرین‌ها و مسیرهای کامل‌شده،
    - بدون مقایسه با دیگران.

| سطح | داده | نمایش در MVP |
|:----|:-----|:-------------|
| عمومی | تعداد تمرین‌های کامل‌شدهٔ کل سیستم | ✅ بله |
| عمومی | تعداد مسیرهای تمام‌شدهٔ کل سیستم | ✅ بله |
| عمومی | تعداد کاربران فعال | ✅ بله |
| عمومی | میانگین score AI کل سیستم | ❌ خیر در MVP |
| عمومی | توزیع سطح مهارت | ❌ خیر در MVP |
| عمومی | Leaderboard / رتبه‌بندی | ❌ هرگز |
| فردی | trend امتیازهای AI کاربر | ✅ بله |
| فردی | نمودار پیشرفت تمرین‌ها | ✅ بله |
| فردی | مقایسه با میانگین دیگران | ❌ خیر در MVP |
| فردی | رتبهٔ کاربر نسبت به دیگران | ❌ هرگز |

### ۷.۲. Idea Playground و مودهای خلاقیت

- **Idea Playground (زمین بازی ایده‌ها)** به‌عنوان بخش سبک و بازی‌محور خلاقیت در پلتفرم تعریف می‌شود.
- در MVP، یک مود اصلی پیاده می‌شود:

  #### مود ۱ – Creative Clash (تضاد خلاق) – در MVP

  - سه گردونهٔ تصادفی:
    - شخصیت (Character)،
    - مکان (Location)،
    - شیء/مفهوم (Object/Concept).
  - کاربر دکمهٔ «بچرخان» را می‌زند، سه آیتم تصادفی انتخاب می‌شوند.
  - کاربر **۶۰ ثانیه** فرصت دارد یک جمله (Logline) بنویسد که هر سه را به‌طور خلاقانه به هم ربط دهد.
  - پس از پایان زمان، می‌تواند:
    - متن را کپی کند،
    - و اگر لاگین است، در فازهای بعدی امکان ذخیرۀ این جرقه‌ها در پروفایل می‌تواند اضافه شود.
  - در MVP:
    - متن Logline به‌صورت پیش‌فرض در DB ذخیره نمی‌شود (Persist اختیاری برای فازهای بعدی است)،
    - فقط رفتار و شمار کل دفعات استفاده ممکن است در لایۀ Analytics به‌صورت تجمیعی و غیرشخصی ثبت شود.
  - این مود:
    - هیچ نمرهٔ رسمی یا امتیاز رقابتی ندارد،
    - صرفاً به‌عنوان «تمرین خلاقیت» و warm-up پیش از تمرین‌های اصلی استفاده می‌شود.

- **مودهای رزروشده برای بعد از MVP (در این بریف فقط نام‌برده می‌شوند):**

  - **مود ۲ – Micro-story (مینی‌داستان):**
    - مشابه Creative Clash، اما کاربر ۱۰ دقیقه وقت دارد یک مینی‌داستان ۲۰۰–۳۰۰ کلمه‌ای بنویسد.
    - می‌توان در فاز بعد از AI برای بازخورد سبک استفاده کرد.

  - **مود ۳ – اتاق فرار کلمات / جوهر فرّار:**
    - فضای نوشتن جریان سیال؛
    - اگر کاربر بیش از N ثانیه (مثلاً ۵ ثانیه) کاملاً دست از تایپ بکشد، متن شروع به محوشدن یا در حالت چالش‌برانگیزتر، پاک‌شدن می‌کند.
    - این مود برای فاز بعد و در هماهنگی با فلسفۀ فصل ۱۶ (ساختارشکنی) طراحی می‌شود.

- پیاده‌سازی مودهای ۲ و ۳ نیازمند Spec و ADR جداگانه است و بخشی از MVP نیستند؛ اما معماری و لایهٔ Frontend/Backend به‌گونه‌ای طراحی می‌شود که افزودن آن‌ها در آینده ساده باشد.

---

## ۸. نقشهٔ راه فیچرها (Feature Roadmap)

این جدول خلاصهٔ وضعیت هر فیچر، جایگاهش در MVP یا فازهای بعدی، و وابستگی‌های اصلی آن است.

| فیچر | وضعیت | وابستگی‌ها | یادداشت |
|:------|:-------|:-----------|:--------|
| احراز هویت (Email + Discord) | MVP | Supabase Auth | فیلدهای هویتی: ایمیل، نام مستعار، تاریخ تولد، کشور، زبان، جنسیت؛ در ورود با Discord بعد از OAuth فرم تکمیل پروفایل نمایش داده می‌شود. |
| مسیر «از ایده تا طرح کوتاه» | MVP | Learning Module | حداقل یک مسیر کامل |
| سیستم ارسال تمرین | MVP | Learning Module | draft/submit/autosave؛ محدودیت پیش‌فرض ۱۰ Submit نهایی/روز (قابل تنظیم) |
| بازخورد AI سقراطی | MVP | AI Worker, LLM | مطابق فصل ششم دامنه؛ LLM به‌عنوان Data Processor و بدون Training عمومی داده‌ها |
| بازخورد منتور انسانی | MVP | Feedback Module | صف مشترک Pull-based؛ Trigger در صورت خرابی AI یا پرچم کاربر |
| حلقه‌های نقد (Critique Circles) | MVP | Community Module | Exercise-specific, teen/adult, Participation Lock پویا (N=min(2, #others))، مطابق feature-spec |
| مدیریت ContentItems | MVP | Content Module | مرکز یادگیری |
| پرداخت زرین‌پال | MVP | Commerce Module | داخل ایران (`country='IR'`)، تمام محصولات |
| پرداخت کریپتو (USDT/Polygon) | MVP | Crypto Worker | خارج از ایران (country≠IR)، تمام محصولات (EPUB+NFT، اشتراک‌ها، اعتبار) |
| دانلود EPUB + DownloadToken | MVP | Publishing Worker | نسخۀ دیجیتال بدون DRM آزاردهنده |
| NFT کتاب دیجیتال (خارج از ایران) | MVP | Crypto Worker | نقش گواهی مالکیت دیجیتال؛ بدون توصیه سرمایه‌گذاری |
| حذف حساب (دوحالته) | MVP | Compliance Module | ناشناس‌سازی/حذف کامل؛ اجرای هم‌زمان؛ قطع دسترسی آنلاین مجدد به EPUB |
| Skill Tree (آمار تجمیعی) | MVP | Analytics | بدون Leaderboard؛ Aggregates بلندمدت، Raw Events ۳۰ روزه |
| داشبورد شفافیت و رشد فردی | MVP | Analytics | `/me/transparency` |
| Idea Playground – Creative Clash | MVP | Frontend + (اختیاری) Analytics | مود اصلی بازی خلاقیت، بدون نمره، بدون Persist محتوایی در DB در MVP |
| Book Mode | پس از چاپ | Feature Flag | زیرساخت در MVP آماده |
| Muse Agent (دستیار ایده‌پرداز) | فاز بعد | AI Worker | چت سقراطی برای ایده‌پردازی |
| صفحهٔ هویت نویسنده (Literary DNA) | فاز بعد | Analytics, Embeddings | تحلیل سبک |
| Anthology Generator | فاز بعد | Publishing Worker | EPUB گزیده |
| حلقه‌های نقد thematic | فاز بعد | Community Module | گروه‌های موضوع‌محور |
| Classroom Mode (B2B) | فاز بعد | - | براساس تقاضا |
| مانیتورینگ کامل | MVP | Prometheus/Grafana/Loki/Sentry | self-hosted؛ استفاده از IPهای ناشناس‌شده |

---

این بریف فنی، همراه با:

- `product-domain-spec.md` (۳۳ فصل دامنه)،
- `architecture-fortified-monolith.md` (معماری فنی)،
- `feature-spec-critique-circles.md` (مشخصات کامل حلقه‌های نقد)، و
- `build-plan-stage5.md` (برنامهٔ اجرا)

تصویر واحد و نهایی از سیستمی است که باید ساخته شود؛ از سطح دامنه و تجربه، تا معماری و پیاده‌سازی فنی.  
تمام فیچرهای MVP، سیاست‌های سنی، حریم خصوصی، Critique Circles، پرداخت داخل/خارج، و Idea Playground در این چهارچوب تثبیت شده‌اند و هر تغییر بعدی باید از مسیر ADR و به‌روزرسانی هم‌زمان این اسناد عبور کند.
```
